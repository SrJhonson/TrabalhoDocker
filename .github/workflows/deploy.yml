name: CI/CD Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v3

    - name: Configurar chave SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Login no Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Build da imagem da aplica√ß√£o
      run: docker build -t ${{ secrets.DOCKER_USERNAME }}/minha-aplicacao:latest ./backend

    - name: Push da imagem para o Docker Hub
      run: docker push ${{ secrets.DOCKER_USERNAME }}/minha-aplicacao:latest

    - name: Copiar arquivos para o servidor remoto
      uses: appleboy/scp-action@master
      with:
        host: 201.23.3.86
        username: aluno
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "."
        target: "~/app"
        strip_components: 0

    - name: Executar deploy remoto
      uses: appleboy/ssh-action@master
      with:
        host: 201.23.3.86
        username: aluno
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/app

          echo "üöÄ Reiniciando SonarQube na porta 8151..."
          docker stop sonar || true
          docker rm sonar || true
          docker run -d --name sonar \
            -p 8151:9000 \
            -e SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true \
            sonarqube:lts
            
          echo "‚è≥ Aguardando SonarQube ficar pronto..."
          for i in {1..20}; do
            if curl -s http://localhost:8151/api/system/health | grep -q '"status":"UP"'; then
              echo "‚úÖ SonarQube est√° no ar!"
              break
            fi
            echo "‚è±Ô∏è Esperando..."
            sleep 10
          done

          echo "üß™ Executando an√°lise com sonar-scanner..."
          docker run --rm \
            -v $PWD:/usr/src \
            -w /usr/src \
            sonarsource/sonar-scanner-cli \
            sonar-scanner \
              -Dsonar.projectKey=videogame-app \
              -Dsonar.projectName="Videogame App" \
              -Dsonar.sources=. \
              -Dsonar.host.url=http://127.0.0.1:8151 \
              -Dsonar.login=${{ secrets.SONAR_TOKEN }}

          if [ $? -ne 0 ]; then
            echo "‚ùå An√°lise do SonarQube falhou. Abortando deploy."
            exit 1
          fi

          echo "üõë Encerrando SonarQube..."
          docker stop sonar || true

          echo "üîÅ Atualizando containers da aplica√ß√£o..."
          docker compose down
          docker compose up -d --build

          echo "‚úÖ Deploy conclu√≠do com sucesso!"
